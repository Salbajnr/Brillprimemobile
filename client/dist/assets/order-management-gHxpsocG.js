var H=Object.defineProperty;var J=(l,i,r)=>i in l?H(l,i,{enumerable:!0,configurable:!0,writable:!0,value:r}):l[i]=r;var T=(l,i,r)=>J(l,typeof i!="symbol"?i+"":i,r);import{a as W,b as _,H as X,J as Z,r as d,e as ee,f as I,j as e,m as f,n as y,S as se,I as ae,T as te,o as ie,p as u,q as le,P as C,s as A,t as k,B as D,X as F,K as ne,g as M,L as re,k as ce,v as de,O as q,Q as oe,R as w,V as me}from"./index-CVqmz7v7.js";import{S as xe,a as ue,b as he,c as je,d as U}from"./select-B0T04BLa.js";import{L as pe}from"./live-map-SuCqMwXt.js";import{P as Ne}from"./phone-0BJ47FE1.js";import{C as ge}from"./calendar-RsJxqlG8.js";import{C as ve}from"./check-Bv_Y_Lo5.js";const o=class o{static getInstance(){return o.instance||(o.instance=new o),o.instance}async requestPermission(){return"Notification"in window?Notification.permission==="granted"?"granted":Notification.permission!=="denied"?await Notification.requestPermission():Notification.permission:(console.warn("This browser does not support notifications"),"denied")}async sendNotification(i){if(await this.requestPermission()!=="granted"){console.warn("Notification permission not granted");return}try{const n=new Notification(i.title,{body:i.body,icon:i.icon||"/favicon.ico",badge:i.badge,data:i.data,requireInteraction:!1,silent:!1});n.onclick=()=>{window.focus(),n.close()},setTimeout(()=>{n.close()},5e3)}catch(n){console.error("Failed to send notification:",n)}}isSupported(){return"Notification"in window}getPermissionStatus(){return this.isSupported()?Notification.permission:"denied"}};T(o,"instance");let E=o;const fe=E.getInstance(),V=[{value:"PENDING",label:"Pending",color:"orange"},{value:"CONFIRMED",label:"Confirmed",color:"blue"},{value:"PREPARING",label:"Preparing",color:"yellow"},{value:"READY",label:"Ready for Pickup",color:"green"},{value:"PICKED_UP",label:"Picked Up",color:"purple"},{value:"OUT_FOR_DELIVERY",label:"Out for Delivery",color:"indigo"},{value:"DELIVERED",label:"Delivered",color:"green"},{value:"CANCELLED",label:"Cancelled",color:"red"}];function Re(){const{user:l}=W(),i=_(),{connected:r,orderUpdates:n}=X(),{driverLocations:h}=Z(),[c,G]=d.useState("all"),[j,K]=d.useState(""),[b,Q]=d.useState("ALL"),[a,S]=d.useState(null),[ye,we]=d.useState(!1),[m,p]=d.useState({}),{data:Y=[],isLoading:B,refetch:L}=ee({queryKey:["merchant-orders",l==null?void 0:l.id],queryFn:async()=>{const s=await fetch("/api/fuel/orders/merchant",{credentials:"include"});if(!s.ok)throw new Error("Failed to fetch orders");return(await s.json()).orders||[]},enabled:!!(l!=null&&l.id)&&(l==null?void 0:l.role)==="MERCHANT",refetchInterval:3e4});d.useEffect(()=>{Object.keys(n).length>0&&L()},[n,L]);const N=I({mutationFn:async({orderId:s,status:t,notes:x})=>{const v=await fetch(`/api/fuel/orders/${s}/status`,{method:"PUT",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({status:t,notes:x})});if(!v.ok)throw new Error("Failed to update order status");return v.json()},onSuccess:(s,t)=>{i.invalidateQueries({queryKey:["merchant-orders"]}),fe.showNotification({title:"Order Updated",body:`Order ${t.orderId} status updated to ${t.status}`,tag:"order-update"}),p({type:"success",title:"Order Updated",message:`Order status has been successfully updated to ${t.status}`,show:!0})},onError:()=>{p({type:"error",title:"Update Failed",message:"Failed to update order status. Please try again.",show:!0})}}),P=I({mutationFn:async s=>{const t=await fetch("/api/delivery/request",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({orderId:s})});if(!t.ok)throw new Error("Failed to request delivery");return t.json()},onSuccess:()=>{i.invalidateQueries({queryKey:["merchant-orders"]}),p({type:"success",title:"Delivery Requested",message:"Delivery request has been sent to available drivers.",show:!0})}}),R=Y.filter(s=>{const t=s.orderNumber.toLowerCase().includes(j.toLowerCase())||s.customerName.toLowerCase().includes(j.toLowerCase())||s.customerPhone.includes(j),x=b==="ALL"||s.status===b,v=c==="all"||c==="pending"&&["PENDING","CONFIRMED"].includes(s.status)||c==="active"&&["PREPARING","READY","PICKED_UP","OUT_FOR_DELIVERY"].includes(s.status)||c==="completed"&&["DELIVERED"].includes(s.status)||c==="urgent"&&s.urgentOrder;return t&&x&&v}),O=s=>{const t=V.find(x=>x.value===s);return e.jsx(M,{variant:(t==null?void 0:t.color)==="red"?"destructive":"default",className:"text-xs",children:(t==null?void 0:t.label)||s})},g=(s,t)=>{N.mutate({orderId:s,status:t})},$=s=>{P.mutate(s)},z=({order:s})=>e.jsxs(f,{className:"mb-4 hover:shadow-md transition-shadow",children:[e.jsx(A,{className:"pb-3",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsxs(k,{className:"text-lg flex items-center gap-2",children:[s.orderNumber,s.urgentOrder&&e.jsx(re,{className:"h-4 w-4 text-red-500"})]}),e.jsx("p",{className:"text-sm text-gray-600",children:s.customerName})]}),e.jsxs("div",{className:"text-right",children:[O(s.status),e.jsxs("p",{className:"text-lg font-bold text-green-600 mt-1",children:["₦",s.totalAmount.toLocaleString()]})]})]})}),e.jsxs(y,{children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ne,{className:"h-4 w-4 text-gray-400"}),e.jsx("span",{children:s.customerPhone})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ce,{className:"h-4 w-4 text-gray-400"}),e.jsx("span",{className:"truncate",children:s.deliveryAddress})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ge,{className:"h-4 w-4 text-gray-400"}),e.jsx("span",{children:new Date(s.orderDate).toLocaleDateString()})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(C,{className:"h-4 w-4 text-gray-400"}),e.jsxs("span",{children:[s.quantity,"L ",s.fuelType]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(de,{className:"h-4 w-4 text-gray-400"}),e.jsx(M,{variant:s.paymentStatus==="PAID"?"default":"secondary",children:s.paymentStatus})]}),s.driverName&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(q,{className:"h-4 w-4 text-gray-400"}),e.jsx("span",{children:s.driverName}),h[s.id]&&e.jsx("span",{className:"text-xs text-green-600",children:"Live"})]})]})]}),e.jsxs("div",{className:"flex gap-2 mt-4 flex-wrap",children:[e.jsxs(D,{size:"sm",variant:"outline",onClick:()=>S(s),children:[e.jsx(oe,{className:"h-4 w-4 mr-1"}),"View Details"]}),s.status==="PENDING"&&e.jsxs(w,{loading:N.isPending,onClick:()=>g(s.id,"CONFIRMED"),className:"h-8 px-3 text-sm",children:[e.jsx(ve,{className:"h-4 w-4 mr-1"}),"Confirm"]}),s.status==="CONFIRMED"&&e.jsxs(w,{loading:N.isPending,onClick:()=>g(s.id,"PREPARING"),className:"h-8 px-3 text-sm",children:[e.jsx(me,{className:"h-4 w-4 mr-1"}),"Start Preparing"]}),s.status==="PREPARING"&&e.jsxs(w,{loading:N.isPending,onClick:()=>g(s.id,"READY"),className:"h-8 px-3 text-sm",children:[e.jsx(C,{className:"h-4 w-4 mr-1"}),"Mark Ready"]}),s.status==="READY"&&!s.driverId&&e.jsxs(w,{variant:"outline",loading:P.isPending,onClick:()=>$(s.id),className:"h-8 px-3 text-sm",children:[e.jsx(q,{className:"h-4 w-4 mr-1"}),"Request Delivery"]}),["PENDING","CONFIRMED"].includes(s.status)&&e.jsxs(D,{size:"sm",variant:"destructive",onClick:()=>g(s.id,"CANCELLED"),children:[e.jsx(F,{className:"h-4 w-4 mr-1"}),"Cancel"]})]})]})]});return e.jsx("div",{className:"min-h-screen bg-gray-50 p-4",children:e.jsxs("div",{className:"max-w-6xl mx-auto",children:[e.jsxs("div",{className:"mb-6",children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900 mb-2",children:"Order Management"}),e.jsx("p",{className:"text-gray-600",children:"Manage your incoming orders and track deliveries"}),r&&e.jsxs("div",{className:"flex items-center space-x-2 text-sm text-green-600 mt-2",children:[e.jsx("div",{className:"w-2 h-2 bg-green-500 rounded-full animate-pulse"}),e.jsx("span",{children:"Real-time updates active"})]})]}),e.jsx(f,{className:"mb-6",children:e.jsx(y,{className:"p-4",children:e.jsxs("div",{className:"flex flex-col md:flex-row gap-4",children:[e.jsx("div",{className:"flex-1",children:e.jsxs("div",{className:"relative",children:[e.jsx(se,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 h-4 w-4"}),e.jsx(ae,{placeholder:"Search orders by number, customer name, or phone...",value:j,onChange:s=>K(s.target.value),className:"pl-10"})]})}),e.jsxs(xe,{value:b,onValueChange:Q,children:[e.jsx(ue,{className:"w-full md:w-48",children:e.jsx(he,{placeholder:"Filter by status"})}),e.jsxs(je,{children:[e.jsx(U,{value:"ALL",children:"All Statuses"}),V.map(s=>e.jsx(U,{value:s.value,children:s.label},s.value))]})]})]})})}),e.jsxs(te,{value:c,onValueChange:G,className:"mb-6",children:[e.jsxs(ie,{className:"grid w-full grid-cols-5",children:[e.jsx(u,{value:"all",children:"All Orders"}),e.jsx(u,{value:"pending",children:"Pending"}),e.jsx(u,{value:"active",children:"Active"}),e.jsx(u,{value:"completed",children:"Completed"}),e.jsx(u,{value:"urgent",children:"Urgent"})]}),e.jsx(le,{value:c,children:B?e.jsxs("div",{className:"text-center py-8",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"}),e.jsx("p",{className:"mt-2 text-gray-600",children:"Loading orders..."})]}):R.length===0?e.jsx(f,{children:e.jsxs(y,{className:"text-center py-8",children:[e.jsx(C,{className:"h-12 w-12 text-gray-400 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:"No orders found"})]})}):e.jsx("div",{className:"space-y-4",children:R.map(s=>e.jsx(z,{order:s},s.id))})})]}),a&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:e.jsxs(f,{className:"max-w-4xl w-full max-h-[90vh] overflow-y-auto",children:[e.jsx(A,{children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsxs(k,{children:["Order ",a.orderNumber]}),e.jsx("p",{className:"text-gray-600",children:a.customerName})]}),e.jsx(D,{variant:"ghost",size:"sm",onClick:()=>S(null),children:e.jsx(F,{className:"h-4 w-4"})})]})}),e.jsx(y,{children:e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold mb-3",children:"Order Information"}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Fuel Type:"}),e.jsx("span",{className:"font-medium",children:a.fuelType})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Quantity:"}),e.jsxs("span",{className:"font-medium",children:[a.quantity,"L"]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Total Amount:"}),e.jsxs("span",{className:"font-bold",children:["₦",a.totalAmount.toLocaleString()]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Status:"}),O(a.status)]})]})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold mb-3",children:"Customer Information"}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Name:"})," ",a.customerName]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Phone:"})," ",a.customerPhone]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Email:"})," ",a.customerEmail]})]})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold mb-3",children:"Delivery Information"}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Address:"})," ",a.deliveryAddress]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Order Date:"})," ",new Date(a.orderDate).toLocaleString()]}),a.estimatedDelivery&&e.jsxs("p",{children:[e.jsx("strong",{children:"Est. Delivery:"})," ",new Date(a.estimatedDelivery).toLocaleString()]}),a.driverName&&e.jsxs("p",{children:[e.jsx("strong",{children:"Driver:"})," ",a.driverName]})]})]}),a.notes&&e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold mb-2",children:"Notes"}),e.jsx("p",{className:"text-sm bg-gray-50 p-3 rounded",children:a.notes})]})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold mb-3",children:"Delivery Location"}),e.jsx("div",{className:"h-96 rounded-lg overflow-hidden",children:e.jsx(pe,{showUserLocation:!1,showNearbyUsers:!1,className:"w-full h-full",userRole:"MERCHANT",center:{lat:a.deliveryLatitude,lng:a.deliveryLongitude},markers:[{lat:a.deliveryLatitude,lng:a.deliveryLongitude,title:"Delivery Location",type:"delivery"},...h[a.id]?[{lat:h[a.id].location.lat,lng:h[a.id].location.lng,title:`Driver: ${a.driverName}`,type:"driver"}]:[]]})})]})]})})]})}),e.jsx(ne,{isOpen:m.show,onClose:()=>p({...m,show:!1}),type:m.type,title:m.title,message:m.message})]})})}export{Re as default};
//# sourceMappingURL=order-management-gHxpsocG.js.map
